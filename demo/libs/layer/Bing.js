SuperMap.Layer.Bing=SuperMap.Class(SuperMap.CanvasLayer,{layerName:null,key:null,serverResolutions:[156543.03390625,78271.516953125,39135.7584765625,19567.87923828125,9783.939619140625,4891.9698095703125,2445.9849047851562,1222.9924523925781,611.4962261962891,305.74811309814453,152.87405654907226,76.43702827453613,38.218514137268066,19.109257068634033,9.554628534317017,4.777314267158508,2.388657133579254,1.194328566789627,0.5971642833948135,0.29858214169740677,0.14929107084870338,0.07464553542435169],attributionTemplate:'<span class="olBingAttribution ${type}"><div><a target="_blank" href="http://www.bing.com/maps/"><img src="${logo}" /></a></div>${copyrights}<a style="white-space: nowrap" target="_blank" href="http://www.microsoft.com/maps/product/terms.html">Terms of Use</a></span>',metadata:null,type:"Road",culture:"zh-Hans",metadataParams:null,tileOptions:null,initialize:function(c){var d=this;c=SuperMap.Util.applyDefaults({sphericalMercator:true,projection:"EPSG:3857",numZoomLevels:16},c);var b=c.name||"Bing "+(c.type||this.type);d.layerName=b;d.culture="zh-Hans";d.metadata={};var a=[b,null,null,c];SuperMap.CanvasLayer.prototype.initialize.apply(this,a);this.tileOptions=SuperMap.Util.extend({crossOriginKeyword:"anonymous"},this.options.tileOptions);this.loadMetadata()},clone:function(b){var a=this;if(b==null){b=new SuperMap.CanvasLayer(a.name,a.url,a.layerName,a.getOptions())}b=SuperMap.CanvasLayer.prototype.clone.apply(a,[b]);return b},destroy:function(){var a=this;SuperMap.CanvasLayer.prototype.destroy.apply(a,arguments);a.layerName=null;a.urlTemplate=null;a.culture=null},loadMetadata:function(){this._callbackId="_callback_"+this.id.replace(/\./g,"_");window[this._callbackId]=SuperMap.Function.bind(SuperMap.Layer.Bing.processMetadata,this);var c=SuperMap.Util.applyDefaults({key:this.key,jsonp:this._callbackId,include:"ImageryProviders"},this.metadataParams);var b="http://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.type+"?"+SuperMap.Util.getParameterString(c);var a=document.createElement("script");a.type="text/javascript";a.src=b;a.id=this._callbackId;document.getElementsByTagName("head")[0].appendChild(a)},initLayer:function(){var d=this.metadata.resourceSets[0].resources[0];var b=d.imageUrl.replace("{quadkey}","${quadkey}");b=b.replace("{culture}",this.culture);this.url=[];for(var c=0;c<d.imageUrlSubdomains.length;++c){var a=b.replace("{subdomain}",d.imageUrlSubdomains[c]);if(this.type=="Road"){a=a.replace(/ecn.t([0-9])/,"r$1");a=a.replace(/virtualearth.net/,"ditu.live.com");a=a.replace(/g=[0-9]*/,"g=91")}this.url.push(a)}this.addOptions({maxResolution:Math.min(this.serverResolutions[d.zoomMin],this.maxResolution||Number.POSITIVE_INFINITY),numZoomLevels:Math.min(d.zoomMax+1-d.zoomMin,this.numZoomLevels)},true)},getTileUrl:function(f){if(!this.url){return}var j=f.x,g=f.y,e=f.z;var b=[];for(var c=e;c>0;--c){var h="0";var k=1<<(c-1);if((j&k)!=0){h++}if((g&k)!=0){h++;h++}b.push(h)}var d=b.join("");var a=this.selectUrl(""+j+g+e,this.url);return SuperMap.String.format(a,{quadkey:d})},updateAttribution:function(){var g=this.metadata;if(!g.resourceSets||!this.map||!this.map.center){return}var f=g.resourceSets[0].resources[0];var o=this.map.getExtent().transform(this.map.getProjectionObject(),new SuperMap.Projection("EPSG:4326"));var c=f.imageryProviders,n=SuperMap.Util.indexOf(this.serverResolutions,this.getServerResolution()),a="",h,d,m,b,e,l,k;for(d=0,m=c.length;d<m;++d){h=c[d];for(b=0,e=h.coverageAreas.length;b<e;++b){k=h.coverageAreas[b];l=SuperMap.Bounds.fromArray(k.bbox,true);if(o.intersectsBounds(l)&&n<=k.zoomMax&&n>=k.zoomMin){a+=h.attribution+" "}}}this.attribution=SuperMap.String.format(this.attributionTemplate,{type:this.type.toLowerCase(),logo:g.brandLogoUri,copyrights:a});this.map&&this.map.events.triggerEvent("changelayer",{layer:this,property:"attribution"})},setMap:function(){SuperMap.CanvasLayer.prototype.setMap.apply(this,arguments);this.updateAttribution();this.map.events.register("moveend",this,this.updateAttribution)},CLASS_NAME:"SuperMap.Layer.Bing"});SuperMap.Layer.Bing.processMetadata=function(b){this.metadata=b;this.initLayer();var a=document.getElementById(this._callbackId);a.parentNode.removeChild(a);window[this._callbackId]=undefined;delete this._callbackId};